<%
/**
 * Server-side login endpoint
 * Authenticates user and sets pb_auth cookie
 */

if (request.method !== 'post') {
  response.json(405, { error: 'Method not allowed' });
  return;
}

try {
  // Parse JSON body
  const data = request.body();
  const { email, password } = data;

  if (!email || !password) {
    response.json(400, { error: 'Email and password are required' });
    return;
  }

  // Find and authenticate user
  const record = $app.findAuthRecordByEmail('users', email);
  if (!record || !record.validatePassword(password)) {
    response.json(401, { error: 'Invalid email or password' });
    return;
  }

  // Generate auth token
  const token = record.newAuthToken();

  // Set pb_auth cookie with token and record data
  const recordData = {
    id: record.id,
    email: record.email()
  };

  // Add optional fields if they exist
  try { recordData.username = record.username(); } catch (e) {}
  try { recordData.name = record.name(); } catch (e) {}
  try { recordData.avatar = record.avatar(); } catch (e) {}

  response.cookie('pb_auth', JSON.stringify({
    token: token,
    record: recordData
  }));

  // Return success
  response.json(200, {
    success: true,
    user: {
      id: record.id,
      email: record.email()
    }
  });

} catch (error) {
  response.json(401, {
    error: error.message || 'Authentication failed'
  });
}
%>