<%
/**
 * Server-side login endpoint
 * Uses the auth plugin to properly set the pb_auth cookie
 */

// Set JSON content type
response.header('Content-Type', 'application/json');

if (request.method !== 'POST') {
  response.status(405);
  response.write(JSON.stringify({ error: 'Method not allowed' }));
  return;
}

try {
  // Parse JSON body
  const body = JSON.parse(request.body);
  const { email, password } = body;

  if (!email || !password) {
    response.status(400);
    response.write(JSON.stringify({ error: 'Email and password are required' }));
    return;
  }

  // Use the auth plugin's signInWithPassword method
  // This will set the pb_auth cookie automatically
  const authData = api.signInWithPassword(email, password);

  // Return success (cookie is already set by the plugin)
  response.write(JSON.stringify({
    success: true,
    user: {
      id: authData.record.id,
      email: authData.record.email
    }
  }));

} catch (error) {
  response.status(401);
  response.write(JSON.stringify({
    error: error.message || 'Authentication failed'
  }));
}
%>
